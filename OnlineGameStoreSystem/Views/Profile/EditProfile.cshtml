@model OnlineGameStoreSystem.Models.ViewModels.EditProfileViewModel

@{
    ViewData["Title"] = "Edit Profile";
}

<div class="container mt-4">
    <h1 class="EditProfile">Edit Profile</h1>


    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }


    <div class="col-md-6">
        <form asp-action="EditProfile" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />

            @* Edit Profile *@
            <div class="edit">

                  @*   {{-- **左侧栏：头像上传和预览 (占 1/3 空间)** --}} *@
                    <div class="left-column">
                 
                        @{
                            // 核心逻辑：如果 Model.AvatarUrl 不为空，使用它；否则，使用默认路径。
                            var avatarSource = !string.IsNullOrEmpty(Model.AvatarUrl)
                            ? Model.AvatarUrl
                            : "/images/avatar_default.png";
                        }

                      @*   {{-- 头像预览 --}} *@
                        <img id="avatarPreview" src="@avatarSource" alt="Current Avatar"
                             style="width: 150px; height: 150px; object-fit: cover;" class="mt-2 rounded-circle" />

                    <div class="form-group mb-3 mt-3 custom-file-upload">
                        @* {{-- 原始文件输入框：添加 hidden-file-input 类来隐藏它 --}} *@
                        <input asp-for="NewAvatarFile" type="file" id="fileInput" class="form-upload hidden-file-input" accept="image/*" />
                        @* {{-- 新增：自定义的上传按钮或区域 --}} *@
                        <button type="button" id="customUploadButton" class="btn btn-primary custom-upload-btn">
                            <i class="fas fa-camera"></i> Upload a new selfie
                        </button>

                        <span asp-validation-for="NewAvatarFile" class="text-danger"></span>
                    </div>

                    </div>

                    @* {{-- **右侧栏：Username 和 Summary (占 2/3 空间)** --}} *@
                    <div class="right-column">

                        @* {{-- Username 表单组 --}} *@
                        <div class="form-group mb-3">
                        <label asp-for="Username" class="form-label">Gamer Tag:</label>
                            <input asp-for="Username" class="form-control" />
                        <span asp-validation-for="Username" class="text-danger" style="color:red"></span>
                        </div>

                      @*   {{-- Summary 表单组 --}} *@
                        <div class="form-group mb-3">
                        <label asp-for="Summary" class="form-label">User Description:</label>
                            <textarea asp-for="Summary" class="form-control" rows="5"></textarea>
                        <span asp-validation-for="Summary" class="text-danger" style="color:red"></span>
                        </div>

                    </div>

            </div>


            <div class="form-group mb-4">
                <h1 class="Tags">Favorite Tags</h1>
                <p class="text">Please select your preferred game tags below:</p>
                @* 使用 flex-wrap 容器来实现横向排列和自动换行 *@
                <div class="tag-flex-container">   
                    @foreach (var tag in Model.AvailableTags)
                    {
                        var isSelected = Model.SelectedTagIds.Contains(tag.Id);

                        <div class="tag-item">

                            <input type="checkbox"
                                   id="tag_@tag.Id"
                                   name="SelectedTagIds"
                                   value="@tag.Id"
                                   class="tag-checkbox"
                                   @(isSelected ? "checked" : "") />

                            <label class="form-check-label tag-pill" for="tag_@tag.Id">
                                @@ @tag.Name
                            </label>

                        </div>
                    }
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn1">Save Changes</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

<script>
    // 获取 HTML 元素
    const fileInput = document.getElementById('fileInput');
    const avatarPreview = document.getElementById('avatarPreview');

    // 监听文件选择变化事件
    fileInput.addEventListener('change', function (e) {
        const files = e.target.files;
        
        // 检查是否有文件被选择
        if (files && files.length > 0) {
            const file = files[0];
            const reader = new FileReader(); // 用于在浏览器中读取文件内容
            
            // 当文件读取操作完成时触发
            reader.onload = function (event) {
                // 将 Data URL 赋给 img 标签的 src 属性，实现即时预览
                avatarPreview.src = event.target.result; 
            };
            
            // 以 Data URL 格式开始读取文件内容
            reader.readAsDataURL(file);
        }
    });

        // 关键 JavaScript: 将点击自定义按钮的事件代理给隐藏的文件输入框
        document.getElementById('customUploadButton').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });
</script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/EditProfile.css" asp-append-version="true" />
}
